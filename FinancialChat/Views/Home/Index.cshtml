@{
    ViewBag.Title = "Home Page";
}

<div class="row">
    <div class="col-md-9">
        <h2>Chat Room</h2>
        <div class="chat-container panel panel-default">
            <div id="chat-messages-box" class="panel-body">
                <div class="messageText alert alert-warning">[00:00:01] ChatBot says: Hi There!. You can query the stock quotes using the following command: /stock=stock_code</div>
            </div>
        </div>
        <div>
            <input class="form-control message left" id="messageText" placeholder="Type your message here..." />
            <a class="btn btn-default right" id="sendButton">Send</a>
        </div>
    </div>
    <div class="col-md-3">
        <h2>Connected Users</h2>
        <div class="">
            <ul class="list-group" id="usersList">
            </ul>
        </div>
    </div>
</div>


@section scripts {

    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

    <script>
        $(function () {

            var chatRoom = $.connection.chatRoom;
            var username = '@ViewBag.UserName';

            initClientEvents(chatRoom);

            // Set initial focus to message input box.
            $('#messageText').focus();

            $.connection.hub.start().done(function () {
                chatRoom.server.connect(username);            

                // Send button on click event
                $('#sendButton').click(function () {

                    var message = $('#messageText').val();

                    if (message) {
                        // Call the Send method on the hub.
                        chatRoom.server.processInput(username, message, new Date().toLocaleString());
                    }
                    
                    // Clear text box and reset focus for next comment.
                    $('#messageText').val('').focus();
                });

                // Send message also with enter key press event
                $("#messageText").keypress(function (e) {
                    if (e.which == 13) {
                        $('#sendButton').click();
                    }
                });
            });
        });

        function initClientEvents(hub) {

            // Refresh user screen
            hub.client.refreshScreen = function (userName, allUsers, messages) {

                // Update connected users list
                allUsers.forEach(function (user) {
                    var node = document.createElement("li");
                    node.id = "user_" + user.ConnectionId;
                    node.classList.add("list-group-item");
                    if (user.UserName == userName) {
                        node.classList.add("list-group-item-success");
                    }
                    var textnode = document.createTextNode(user.UserName);
                    node.appendChild(textnode);
                    document.getElementById("usersList").appendChild(node);
                });
                
                // Add all messages to chat
                for (i = 0; i < messages.length; i++) {
                    writeMessageToScreen(messages[i].Owner, messages[i].TextMessage, messages[i].Time);
                }
            }

            // Add new user to the users list
            hub.client.notifyNewUserConnected = function (id, name) {
                var node = document.createElement("li");
                node.id = "user_" + id;
                node.classList.add("list-group-item");
                var textnode = document.createTextNode(name);
                node.appendChild(textnode);
                document.getElementById("usersList").appendChild(node);
            }

            // Removes user from the list
            hub.client.notifyUserDisconnected = function (id) {
                var ctrId = 'user_' + id;
                $('#' + ctrId).remove();
            }

            // Prints a message to the screen
            hub.client.printMessage = function (userName, message, time) {
                writeMessageToScreen(userName, message, time);
            }            
        }

        // Add a message to the chat window.
        function writeMessageToScreen(userName, message, time) {
            
            $('#chat-messages-box').append('<div class="messageText alert alert-info">[' + time + '] <strong>' + htmlEncode(userName)
                + '</strong> says: ' + htmlEncode(message) + '</div>');

            // Scroll chat window to bottom
        }

        // Html-encode messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }

    </script>
}